{{/* Sender request builder functions template - shared between client and initiator */}}

{{- range .Operations }}
{{- $op := . }}
{{- $hasParams := .HasParams }}
{{- $paramsTypeName := .ParamsTypeName }}
{{- $queryParams := .QueryParams }}
{{- $headerParams := .HeaderParams }}
{{- $cookieParams := .CookieParams }}

{{- /* Generate typed body request builders for content types matching config */ -}}
{{- range .Bodies }}
{{- if .GenerateTyped }}

// {{ typedRequestBuilderName $ $op . }} {{ requestBuilderComment $ $op }} with {{ .ContentType }} body
func {{ typedRequestBuilderName $ $op . }}({{ requestBuilderParams $ $op }}{{ if $hasParams }}, params *{{ $paramsTypeName }}{{ end }}, body {{ .GoTypeName }}) (*http.Request, error) {
	var bodyReader io.Reader
{{- if .IsFormEncoded }}
	values, err := {{ runtimeHelpersPrefix }}MarshalForm(body)
	if err != nil {
		return nil, err
	}
	bodyReader = strings.NewReader(values.Encode())
{{- else }}
	buf, err := json.Marshal(body)
	if err != nil {
		return nil, err
	}
	bodyReader = bytes.NewReader(buf)
{{- end }}
	return {{ requestBuilderName $ $op }}({{ requestBuilderArgs $ $op }}{{ if $hasParams }}, params{{ end }}, "{{ .ContentType }}", bodyReader)
}
{{- end }}
{{- end }}

// {{ requestBuilderName $ . }} {{ requestBuilderComment $ . }}{{ if .HasBody }} with any body{{ end }}
func {{ requestBuilderName $ . }}({{ requestBuilderParams $ . }}{{ if $hasParams }}, params *{{ $paramsTypeName }}{{ end }}{{ if .HasBody }}, contentType string, body io.Reader{{ end }}) (*http.Request, error) {
	var err error
{{- if $.IsClient }}
{{- range $idx, $param := .PathParams }}

	var pathParam{{ $idx }} string
	{{- if .IsPassThrough }}
	pathParam{{ $idx }} = {{ .GoVariableName }}
	{{- else if .IsJSON }}
	var pathParamBuf{{ $idx }} []byte
	pathParamBuf{{ $idx }}, err = json.Marshal({{ .GoVariableName }})
	if err != nil {
		return nil, err
	}
	pathParam{{ $idx }} = string(pathParamBuf{{ $idx }})
	{{- else if .IsStyled }}
	pathParam{{ $idx }}, err = {{ .StyleFunc }}("{{ .Name }}", {{ runtimeParamsPrefix }}ParamLocationPath, {{ .GoVariableName }})
	if err != nil {
		return nil, err
	}
	{{- end }}
{{- end }}

	serverURL, err := url.Parse(server)
	if err != nil {
		return nil, err
	}

	operationPath := fmt.Sprintf("{{ pathFmt .Path }}"{{ range $idx, $_ := .PathParams }}, pathParam{{ $idx }}{{ end }})
	if operationPath[0] == '/' {
		operationPath = "." + operationPath
	}

	reqURL, err := serverURL.Parse(operationPath)
	if err != nil {
		return nil, err
	}
{{- else }}

	reqURL, err := url.Parse(targetURL)
	if err != nil {
		return nil, err
	}
{{- end }}
{{- if $queryParams }}

	if params != nil {
		queryValues := reqURL.Query()
{{- range $idx, $param := $queryParams }}
		{{- if .HasOptionalPointer }}
		if params.{{ .GoName }} != nil {
		{{- end }}
		{{- if .IsPassThrough }}
		queryValues.Add("{{ .Name }}", {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }})
		{{- else if .IsJSON }}
		if queryParamBuf, err := json.Marshal({{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }}); err != nil {
			return nil, err
		} else {
			queryValues.Add("{{ .Name }}", string(queryParamBuf))
		}
		{{- else if .IsStyled }}
		if queryFrag, err := {{ .StyleFunc }}("{{ .Name }}", {{ runtimeParamsPrefix }}ParamLocationQuery, {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }}); err != nil {
			return nil, err
		} else if parsed, err := url.ParseQuery(queryFrag); err != nil {
			return nil, err
		} else {
			for k, v := range parsed {
				for _, v2 := range v {
					queryValues.Add(k, v2)
				}
			}
		}
		{{- end }}
		{{- if .HasOptionalPointer }}
		}
		{{- end }}
{{- end }}
		reqURL.RawQuery = queryValues.Encode()
	}
{{- end }}

	req, err := http.NewRequest("{{ .Method }}", reqURL.String(), {{ if .HasBody }}body{{ else }}nil{{ end }})
	if err != nil {
		return nil, err
	}

	{{ if .HasBody }}req.Header.Add("Content-Type", contentType){{ end }}
{{- if $headerParams }}

	if params != nil {
{{- range $idx, $param := $headerParams }}
		{{- if .HasOptionalPointer }}
		if params.{{ .GoName }} != nil {
		{{- end }}
		var headerParam{{ $idx }} string
		{{- if .IsPassThrough }}
		headerParam{{ $idx }} = {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }}
		{{- else if .IsJSON }}
		var headerParamBuf{{ $idx }} []byte
		headerParamBuf{{ $idx }}, err = json.Marshal({{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }})
		if err != nil {
			return nil, err
		}
		headerParam{{ $idx }} = string(headerParamBuf{{ $idx }})
		{{- else if .IsStyled }}
		headerParam{{ $idx }}, err = {{ .StyleFunc }}("{{ .Name }}", {{ runtimeParamsPrefix }}ParamLocationHeader, {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }})
		if err != nil {
			return nil, err
		}
		{{- end }}
		req.Header.Set("{{ .Name }}", headerParam{{ $idx }})
		{{- if .HasOptionalPointer }}
		}
		{{- end }}
{{- end }}
	}
{{- end }}
{{- if $cookieParams }}

	if params != nil {
{{- range $idx, $param := $cookieParams }}
		{{- if .HasOptionalPointer }}
		if params.{{ .GoName }} != nil {
		{{- end }}
		var cookieParam{{ $idx }} string
		{{- if .IsPassThrough }}
		cookieParam{{ $idx }} = {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }}
		{{- else if .IsJSON }}
		var cookieParamBuf{{ $idx }} []byte
		cookieParamBuf{{ $idx }}, err = json.Marshal({{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }})
		if err != nil {
			return nil, err
		}
		cookieParam{{ $idx }} = url.QueryEscape(string(cookieParamBuf{{ $idx }}))
		{{- else if .IsStyled }}
		cookieParam{{ $idx }}, err = {{ runtimeParamsPrefix }}StyleSimpleParam("{{ .Name }}", {{ runtimeParamsPrefix }}ParamLocationCookie, {{ if .HasOptionalPointer }}*{{ end }}params.{{ .GoName }})
		if err != nil {
			return nil, err
		}
		{{- end }}
		cookie{{ $idx }} := &http.Cookie{
			Name:  "{{ .Name }}",
			Value: cookieParam{{ $idx }},
		}
		req.AddCookie(cookie{{ $idx }})
		{{- if .HasOptionalPointer }}
		}
		{{- end }}
{{- end }}
	}
{{- end }}

	return req, nil
}
{{- end }}
